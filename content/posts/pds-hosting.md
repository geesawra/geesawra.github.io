+++
title = 'How I run my ATProto PDS'
date = 2025-04-29T12:51:40+02:00
draft = true
author = "geesawra"
+++

Hi!
I run my own ATProto PDS, for various reasons:

- I want to own my data.
- It's a good way to make the system resilient against centralized infrastructure.
- I'm a nerd.

To do so, and do it cheaply, last year I posed myself a challenge: buy the cheapest VPS during Black Friday deals and host on it.

{{< bskypost src=https://bsky.app/profile/geesawra.industries/post/3lc7bzgmf2s25 >}}

Admittedly it hasn't been a flawless experience --- mostly due to cheap hosting, done on purpose --- but the process gave me the knowledge and confidence to run my main account on it: this post explains how I did it.

A nice property of PDS hosting is that it doesn't require much resources: the only media you're storing is your own, and the nature of the relay architecture means you get limited traffic aimed directly at your server --- except if you're [hosting your own website](/posts/pds-website.html) on it!

As I'm a huge fan of [Alpine Linux](https://alpinelinux.org/), I installed it through the VPS administration panel, and as expected, it has been perfect.

I use a variation of the [official](https://github.com/bluesky-social/pds) Bluesky [`compose.yml`](https://github.com/bluesky-social/pds/blob/main/compose.yaml) file, that I extracted straight from their repository, as I don't like the `install.sh` approach --- I run many services on my machines, all of them containerized.

I kept Caddy as my reverse proxy of choice because it's set-and-forget once configured properly, and the configuration Bluesky provides just works.

I'm not a fan of `containrrr/watchtower`: I've been bitten in the past by unregulated upgrades, mostly due to pulling Docker images with the `latest` flag, and I'd like not to repeat that experience anymore.

The entire stack is executed on rootless [Podman](https://podman.io/), managed remotely through [Portainer](https://www.portainer.io/).

> My philosophy for this deployment is "do the best you can": posting on Bluesky is _not a vital service_ for me, I'm okay with a few hours of downtime.

To keep up to date with new releases I subscribed to Github notifications.

So far updates have been smooth, I never had issues stemming from `docker pull`ing every once in a while, and the only true issue I had was due to bad clock on the host machine: **always run an NTP daemon**!

To further mitigate downtime and data loss, I backup the data directory on [Borgbase](https://borgbase.com) with [Restic](https://restic.net/) every few hours --- I also schedule regular scrubs and checks with the same Docker image.

Without further ado, here's the `compose.yml` file:

```yml
version: "3.9"
services:
  pds:
    container_name: pds
    image: ghcr.io/bluesky-social/pds:0.4
    restart: unless-stopped
    env_file: "./stack.env"
    volumes:
      - type: bind
        source: ${DATADIR}
        target: /pds
  caddy:
    image: caddy:latest
    restart: unless-stopped
    command: caddy run --config /etc/caddy/Caddyfile
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ${DATADIR}/geesawra.industries:/geesawra.industries
      - ${DATADIR}/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ${DATADIR}/caddy/data:/data
      - ${DATADIR}/caddy/config:/config

  backup:
    image: mazzolino/restic
    hostname: docker
    restart: unless-stopped
    environment:
      RUN_ON_STARTUP: "true"
      BACKUP_CRON: "*/45 * * * *"
      RESTIC_CHECK_ARGS: >-
        --read-data-subset=10%
      RESTIC_REPOSITORY: rest:[REDACTED]
      RESTIC_PASSWORD: [REDACTED]
      RESTIC_BACKUP_SOURCES: /mnt/pds
      RESTIC_BACKUP_ARGS: >-
        --tag pds
      RESTIC_FORGET_ARGS: >-
        --keep-last 10
        --keep-daily 7
        --keep-weekly 5
        --keep-monthly 12
      TZ: Europe/Berlin
    volumes:
      - ${DATADIR}:/mnt/pds:ro

  prune:
    image: mazzolino/restic
    hostname: docker
    restart: unless-stopped
    environment:
      SKIP_INIT: "true"
      RUN_ON_STARTUP: "false"
      PRUNE_CRON: "0 0 4 * * *"
      RESTIC_REPOSITORY: rest:[REDACTED]
      RESTIC_PASSWORD: [REDACTED]
      TZ: Europe/Berlin

  check:
    image: mazzolino/restic
    hostname: docker
    restart: unless-stopped
    environment:
      SKIP_INIT: "true"
      RUN_ON_STARTUP: "false"
      CHECK_CRON: "0 15 5 * * *"
      RESTIC_CHECK_ARGS: >-
        --read-data-subset=10%
      RESTIC_REPOSITORY: rest:[REDACTED]
      RESTIC_PASSWORD: [REDACTED]
      TZ: Europe/Berlin
```

Two notable features in this `compose.yml`:

- As `pds` needs several environment variables to be configured, I'm storing them in a `stack.env` file, generated by Portainer, to set them.
- I'm binding the host volume path to `${DATADIR}`, which is defined in `stack.env`.

Running a PDS is not exactly easy, but should be viable for anyone with experience with containers and with reasonable comfort with the Linux shell.

On a positive note, migrating my account from `bsky.social` to my own PDS has been a great experience, and it's certainly something the ActivityPub folks should look into for their next protocol iteration.

{{< bskypost src=https://bsky.app/profile/geesawra.industries/post/3l772nfieyk2t >}}

{{< bskypost src=https://bsky.app/profile/geesawra.industries/post/3l772vddndc2t >}}

As you can see, I was considerably salty :^)

Until next time!
